<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.4">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>NationHub</title>
  <meta name="description"
    content="Explore countries from around the world, including their capitals, languages, populations, and more. Discover interesting information about each country.">
  <meta name="keywords" content="countries, world, capitals, languages, populations, facts, information">
  <meta name="author" content="flAks">
  <link rel="icon" type="image/png" href="/images/favicon-32x32.png">
  <link async rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link async rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  <link rel="stylesheet" href="/css/_dark-mode.css">
  <link rel="stylesheet" href="/css/_spinner.css">
  <link rel="stylesheet" href="/css/_main.css">
  <link rel="stylesheet" href="/css/_table.css">
  <link rel="stylesheet" href="/css/_portrait-orientation.css">
  <link rel="stylesheet" href="/css/_spinner.css">
</head>

<body>

  <div class="header-container">
    <h1>
      <span class="material-symbols-outlined logo" onclick="location.reload()">public</span>
      <span class="header" onclick="location.reload()">NationHub</span>
      <span class="material-symbols-outlined settings" onclick="showSettingsWindow()">settings</span>
      <span id="dark-mode-toggle" class="material-symbols-outlined dark-mode-icon"
        onclick="toggleDarkMode()">dark_mode</span>
    </h1>
    <input type="text" id="search-input" placeholder="Search country..." oninput="handleSearch()">
    <button class="filter-button" onclick="showFilterWindow()">Filter</button>
  </div>

  <div class="about-container">
    <a class="about-button" href="/about.html">About Us</a>
  </div>

  <div class="table-container">
    <table id="countries-table">
      <tr>
        <th class="flag-column"></th>
        <th class="country-column">
          <span>Country</span>
          <button class="sort-button" onclick="sortTable()">
            <span id="sort-symbol" class="material-symbols-outlined sort-icon">switch_right</span>
          </button>
        </th>
      </tr>
    </table>

    <div class="overlay"></div>

    <div id="filter-window">
      <h2 class="filter-title">Filter Settings</h2>
      <div class="parameter-container">
        <h3>Region</h3>
        <div class="toggle-container" id="region-toggle-container">
          <script>
            const regions = ['Africa', 'Americas', 'Asia', 'Europe', 'Oceania'];
            const regionToggleContainer = document.getElementById('region-toggle-container');
            regionToggleContainer.innerHTML = regions.map(region => `
              <div class="toggle-item">
                <strong>${region}:</strong>
                <label class="toggle-label" for="region-filter-toggle-${region.toLowerCase()}">
                  <input type="checkbox" id="region-filter-toggle-${region.toLowerCase()}" hidden>
                  <img class="toggle-icon" src="/images/toggle_off.svg" alt="Toggle Icon">
                </label>
              </div>`).join('');
          </script>
        </div>
      </div>
      <div class="button-container">
        <button id="reset-filter-button" class="reset-button" onclick="resetFilters()">Reset Filters</button>
        <button id="apply-filter-button" class="apply-button" onclick="filterCountriesByRegion()">Apply Filter</button>
      </div>
      <span class="material-symbols-outlined close-icon">close</span>
    </div>

    <div id="settings-window">
      <h2 class="settings-title">Settings</h2>
      <div class="toggle-container">
        <strong>Open Big Card by Default:</strong>
        <label class="toggle-label" for="big-card-toggle">
          <input type="checkbox" id="big-card-toggle" hidden>
          <img class="toggle-icon" src="/images/toggle_off.svg" alt="Toggle Icon">
        </label>
      </div>
      <span class="material-symbols-outlined close-icon">close</span>
    </div>

    <div id="map-window">
      <h2 class="map-title">Map of <span id="country-name"></span></h2>
      <div id="map-buttons">
        <button id="googlemaps-button">
          <img class="map-button-icon" src="images/maps-icon.svg" alt="GoogleMap Logo">
        </button>
        <button id="openstreetmap-button">
          <img class="map-button-icon" src="images/osm-icon.svg" alt="OpenStreetMap Logo">
        </button>
      </div>
      <span class="material-symbols-outlined close-icon">close</span>
      <div id="map-container"></div>
    </div>

    <div class="table" id="city-table"></div>

    <div class="pagination">
      <div class="pagination-container"></div>
    </div>

    <script async src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="/caching.js"></script>
    <script>
      const h1Element = document.querySelector('h1');
      const paginationElement = document.querySelector('.pagination');
      const mapWindow = document.getElementById('map-window');
      const cityTable = document.getElementById('city-table');
      const paginationContainer = document.querySelector('.pagination-container');
      const countriesTable = document.getElementById('countries-table');
      const overlay = document.querySelector('.overlay');
      const countryNameElement = document.getElementById('country-name');
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const filterWindow = document.getElementById('filter-window');
      const settingsWindow = document.getElementById('settings-window');
      const sortButton = document.querySelector('.sort-button');
      const regionToggleLabels = document.querySelectorAll('#filter-window .toggle-label');
      const regionToggles = document.querySelectorAll('input[type="checkbox"][id^="region-filter-toggle-"]');

      let bigCardToggle;
      let map = null;
      let marker = null;
      let sortOrder = true;
      let currentPage = 1;
      let totalPages = 1;
      let toggleStates = [];
      let filteredCountries = [];
      let independentCountries = [];
      let countriesPerPage = calculateCountriesPerPage();
      function calculateCountriesPerPage() {
        const h1Rect = h1Element.getBoundingClientRect();
        const paginationRect = paginationElement.getBoundingClientRect();
        const distanceToButtons = paginationRect.top - (h1Rect.top + h1Rect.height);
        const heightDifference = window.innerHeight - window.innerWidth;
        if (window.matchMedia("(orientation: portrait)").matches) {
          const screenHeight = window.innerHeight;
          const distanceToCenter = screenHeight / 2 - (h1Rect.top + h1Rect.height);
          const fontSize = 16 + heightDifference / 100;
          document.body.style.fontSize = fontSize + 'px';
          return Math.floor(distanceToCenter / 58);
        } else {
          document.body.style.fontSize = '16px';
          return Math.floor(distanceToButtons / 42.65);
        }
      }

      window.addEventListener('resize', function () {
        countriesPerPage = calculateCountriesPerPage();
        renderPagination(Math.ceil(independentCountries.length / countriesPerPage));
        if (mapWindow && mapWindow.style.display === 'block') {
          hideMapOfCountry();
        }
        if (cityTable && cityTable.style.display === 'block') {
          hideCountryCitiesTable();
        }
        if (filterWindow && filterWindow.style.display === 'block') {
          hideFilterWindow();
        }
        hideCountryInfo();
        setCurrentPage(1);
      });

      function fetchCountries() {
        fetch('https://restcountries.com/v3.1/all')
          .then(response => response.json())
          .then(data => {
            independentCountries = data.filter(country => country.independent);
            independentCountries.sort((a, b) => a.name.common.localeCompare(b.name.common));
            filterCountriesByRegion();
          })
          .catch(error => console.log('Error:', error));
      }

      function renderPagination(totalPages) {
        paginationContainer.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
          const button = document.createElement('button');
          button.textContent = i;
          button.addEventListener('click', () => setCurrentPage(i));
          if (i === currentPage) {
            button.classList.add('active');
          }
          paginationContainer.appendChild(button);
        }
      }

      async function renderCountriesTable(countries, currentPage) {
        const startIndex = (currentPage - 1) * countriesPerPage;
        countriesTable.innerHTML = `
          <tr>
            <th class="flag-column"></th>
            <th class="country-column">
              <span>Country</span>
              <button class="sort-button" onclick="sortTable()">
                <span id="sort-symbol" class="material-symbols-outlined sort-icon">switch_right</span>
              </button>
            </th>
          </tr>`;
        const imagePromises = [];
        const fragment = document.createDocumentFragment();
        for (let i = startIndex; i < startIndex + countriesPerPage; i++) {
          const country = filteredCountries[i];
          if (!country) break;
          const countryName = country.name.common;
          const row = document.createElement('tr');
          const imagePromise = loadResource(`https://flagcdn.com/24x18/${getCountryCode(country)}.png`, 'image');
          imagePromises.push(imagePromise);
          const imageCell = document.createElement('td');
          const countryNameCell = document.createElement('td');
          countryNameCell.textContent = countryName;
          row.appendChild(imageCell);
          row.appendChild(countryNameCell);
          row.addEventListener('click', () => bigCardToggle.checked ? showExpandedCountryInfo(row, country) : showCountryInfo(row, country));
          fragment.appendChild(row);
        }
        countriesTable.appendChild(fragment);
        const images = await Promise.all(imagePromises);
        const flagCells = Array.from(countriesTable.querySelectorAll('td:first-child'));
        flagCells.forEach((cell, index) => {
          const img = document.createElement('img');
          img.src = images[index].src;
          img.width = 24;
          img.height = 18;
          img.alt = filteredCountries[startIndex + index].name.common + 'Flag';
          cell.appendChild(img);
        });
      }

      function handleSearch() {
        const searchInput = document.getElementById('search-input');
        const filterValue = searchInput.value.toLowerCase();
        const visibleCountries = independentCountries.filter(country =>
          country.name.common.toLowerCase().startsWith(filterValue)
        );
        renderCountriesTable(visibleCountries, currentPage);
      }

      regionToggleLabels.forEach(function (toggleLabel, index) {
        const toggleIcon = toggleLabel.querySelector('.toggle-icon');
        const regionToggle = regionToggles[index];
        toggleLabel.addEventListener('click', function () {
          regionToggle.checked = !regionToggle.checked;
          toggleIcon.src = regionToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
          localStorage.setItem(regionToggle[index], regionToggle.checked);
        });
        const initialRegionToggleValue = localStorage.getItem(regionToggle[index]);
        const initialToggleState = initialRegionToggleValue ? initialRegionToggleValue === 'true' : false;
        regionToggle.checked = initialToggleState;
        toggleIcon.src = initialToggleState ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
      });

      function filterCountriesByRegion() {
        const selectedRegions = Array.from(regionToggles)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.id.split('-').pop().toUpperCase());
        filteredCountries = independentCountries.filter(country =>
          selectedRegions.includes(country.region.toUpperCase())
        );
        totalPages = Math.ceil(filteredCountries.length / countriesPerPage);
        currentPage = 1;
        renderPagination(totalPages);
        renderCountriesTable(filteredCountries, currentPage);
        regionToggles.forEach((regionToggle, index) => {
          const toggleIcon = regionToggleLabels[index].querySelector('.toggle-icon');
          toggleStates[index] = regionToggle.checked;
          localStorage.setItem(`regionToggle${index}`, regionToggle.checked);
          toggleIcon.src = regionToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
        });
        hideCountryInfo();
      }

      function resetFilters() {
        regionToggles.forEach(checkbox => checkbox.checked = true);
        hideCountryInfo();
        filterCountriesByRegion();
      }

      function setCurrentPage(page) {
        currentPage = page;
        renderPagination(totalPages);
        renderCountriesTable(independentCountries, currentPage);
      }

      let openCountryRow = null;
      let openExpandedCountryRow = null;

      function showExpandedCountryInfo(row, country) {
        if (!(openExpandedCountryRow && openExpandedCountryRow.rowElement === row)) {
          hideCountryInfo();
          const countryCard = document.createElement('div');
          countryCard.classList.add('country-card');
          countryCard.innerHTML = '<div class="loader"></div>';
          const apiUrl = `https://api.api-ninjas.com/v1/country?name=${getCountryCode(country)}`;
          loadResource(apiUrl, 'text', { headers: { 'X-Api-Key': 'W+OQ/iBAPzIQYLIRvdQgVQ==ixnCBWtlJHxmXrMv' } })
            .then(data => {
              const cachedData = JSON.parse(data);
              renderCountryInfo(cachedData);
            })
            .catch(error => {
              handleError(error, countryCard);
            });

          function renderCountryInfo(data) {
            const countryData = data[0];
            const gdp = countryData.gdp || 'N/A';
            const gdpGrowth = countryData.gdp_growth || 'N/A';
            const gdpPerCapita = countryData.gdp_per_capita || 'N/A';
            const territory = countryData.surface_area || 'N/A';
            const currencyCode = getCurrencyCode(country.currencies);
            const exchangeUrl = `https://api.api-ninjas.com/v1/convertcurrency?have=${currencyCode}&want=USD&amount=1`;
            loadResource(exchangeUrl, 'text')
              .then(data => {
                const cachedData = JSON.parse(data);
                displayCountryInfo(cachedData);
              })
              .catch(error => {
                handleError(error, countryCard);
              });

            async function displayCountryInfo(data) {
              const exchangeRate = data.new_amount;
              const currencyDisplay = `${currencyCode} (${exchangeRate.toFixed(2)} USD)`;
              const flagImage = await loadResource(`https://flagcdn.com/h120/${getCountryCode(country)}.png`, 'image');
              countryCard.innerHTML = `
                <span class="flag-coat">
                  <img class="flag-image" src="${flagImage.src}" alt="${country.name.common} Flag">
                  <img class="coat-image" src="https://mainfacts.com/media/images/coats_of_arms/${getCountryCode(country)}.svg" alt="${country.name.common} Coat" loading="lazy">
                </span>
                <span class="material-symbols-outlined close-icon">close</span>
                <h2>
                  ${country.name.common}
                  <span class="material-symbols-outlined map-icon" onclick="showMapOfCountry('${country.name.common}')">location_on</span>
                  <span class="material-symbols-outlined cities-icon" onclick="showCountryCitiesTable('${country.name.common}')">apartment</span>
                </h2>
                <p><strong>Capital:</strong> ${country.capital}</p>
                <p><strong>Language:</strong> ${country.languages[Object.keys(country.languages)[0]]}</p>
                <p><strong>Currency:</strong> ${currencyDisplay}</p>
                <p><strong>GDP:</strong> $${(gdp / 1000).toFixed(2)}b <i class="fas fa-dollar-sign"></i></p>
                <p><strong>GDP Per Capita:</strong> $${gdpPerCapita} <i class="fas fa-dollar-sign"></i></p>
                <p><strong>GDP Growth:</strong> <span class="gdp-growth ${gdpGrowth > 0 ? 'positive' : 'negative'}">${gdpGrowth}% ${gdpGrowth > 0 ? '&#8593;' : '&#8595;'}</span></p>
                <p><strong>Population:</strong> ${country.population.toLocaleString()}</p>
                <p><strong>Territory:</strong> ${territory} km<sup>2</sup></p>
                <p><strong>Region:</strong> ${country.region}/${country.subregion}</p>
                <p><strong>Neighboring Countries:</strong> ${getNeighboringCountries(country)}</p>
                <span class="wiki-icon" onclick="openCountryWiki('${country.name.common}')">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/1/14/OOjs_UI_icon_logo-wikipedia.svg" alt="Wikipedia">
                </span>
                <span id="expand-icon-less" class="material-symbols-outlined">expand_less</span>`;
              const closeIcon = countryCard.querySelector('.close-icon');
              closeIcon?.addEventListener('click', () => hideCountryInfo());
              const expandIcon = document.getElementById('expand-icon-less');
              expandIcon?.addEventListener('click', () => showCountryInfo(row, country));
              const maxHeight = window.innerHeight * 0.7;
              if (countryCard.offsetHeight > maxHeight) {
                countryCard.style.fontSize = '12px';
              } else {
                countryCard.style.fontSize = '18px';
              }
            }
          }
          row.classList.add('selected');
          document.body.appendChild(countryCard);
          openExpandedCountryRow = {
            rowElement: row,
            countryCard: countryCard
          };
        }
      }

      async function showCountryInfo(row, country) {
        if (!(openCountryRow && openCountryRow.rowElement === row)) {
          hideCountryInfo();
          const countryCard = document.createElement('div');
          countryCard.classList.add('country-card');
          const flagImage = await loadResource(`https://flagcdn.com/h120/${getCountryCode(country)}.png`, 'image');
          countryCard.innerHTML = `
            <img src="${flagImage.src}" height="120" width="190" alt="${country.name.common} Flag">
            <span class="material-symbols-outlined close-icon">close</span>
            <h2>${country.name.common}</h2>
            <p><strong>Capital:</strong> ${country.capital}</p>
            <p><strong>Language:</strong> ${country.languages[Object.keys(country.languages)[0]]}</p>
            <p><strong>Population:</strong> ${country.population.toLocaleString()}</p>
            <span id="expand-icon" class="material-symbols-outlined">expand_more</span>`;
          row.classList.add('selected');
          document.body.appendChild(countryCard);
          openCountryRow = {
            rowElement: row,
            countryCard: countryCard
          };
          const closeIcon = countryCard.querySelector('.close-icon');
          closeIcon?.addEventListener('click', () => hideCountryInfo());
          const expandIcon = document.getElementById('expand-icon');
          expandIcon?.addEventListener('click', () => showExpandedCountryInfo(row, country));
        }
      }

      function showNeighboringCountry(countryName) {
        if (!countryName) return;
        const country = independentCountries.find(c => c.name.common === countryName);
        let row = getRowOfCountry(country);
        if (!row) {
          const countryIndex = independentCountries.findIndex(c => c.name.common === country.name.common);
          const page = Math.ceil((countryIndex + 1) / countriesPerPage);
          setCurrentPage(page);
          row = getRowOfCountry(country);
        }
        function getRowOfCountry(country) {
          const rows = countriesTable.getElementsByTagName('tr');
          for (let i = 1; i < rows.length; i++) {
            const currentRow = rows[i];
            const countryName = currentRow.getElementsByTagName('td')[1].textContent.trim();
            if (countryName === country.name.common) {
              return currentRow;
            }
          }
          return null;
        }
        showExpandedCountryInfo(row, country);
      }

      function hideCountryInfo() {
        if (openCountryRow) {
          if (openCountryRow.rowElement) {
            openCountryRow.rowElement.classList.remove('selected');
          }
          if (openCountryRow.countryCard) {
            document.body.removeChild(openCountryRow.countryCard);
          }
          openCountryRow = null;
        }
        if (openExpandedCountryRow) {
          if (openExpandedCountryRow.rowElement) {
            openExpandedCountryRow.rowElement.classList.remove('selected');
          }
          if (openExpandedCountryRow.countryCard) {
            document.body.removeChild(openExpandedCountryRow.countryCard);
          }
          openExpandedCountryRow = null;
        }
      }

      function showMapOfCountry(countryName) {
        const country = independentCountries.find(country => country.name.common === countryName);
        if (!country) return;
        countryNameElement.textContent = countryName;
        overlay.style.display = 'block';
        mapWindow.style.display = 'block';
        const closeButton = mapWindow.querySelector('.close-icon');
        closeButton.addEventListener('click', hideMapOfCountry);
        overlay.addEventListener('click', hideMapOfCountry);
        mapWindow.appendChild(document.getElementById('map-container'));
        if (marker) {
          map.removeLayer(marker);
        }
        if (!map) {
          map = L.map('map-container');
          const openstreetmapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          });
          const googlemapsStreetsLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
          });
          googlemapsStreetsLayer.addTo(map);
          const openstreetmapButton = document.getElementById('openstreetmap-button');
          const googlemapsButton = document.getElementById('googlemaps-button');
          openstreetmapButton.addEventListener('click', () => {
            if (map.hasLayer(googlemapsStreetsLayer)) {
              map.removeLayer(googlemapsStreetsLayer);
              openstreetmapLayer.addTo(map);
            }
          });
          googlemapsButton.addEventListener('click', () => {
            if (!map.hasLayer(googlemapsStreetsLayer)) {
              map.removeLayer(openstreetmapLayer);
              googlemapsStreetsLayer.addTo(map);
            }
          });
        }
        map.setView([country.latlng[0], country.latlng[1]], 5);
        const markerIcon = L.icon({
          iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/d/d1/Google_Maps_pin.svg',
          iconSize: [25, 41],
          iconAnchor: [12, 41]
        });
        marker = L.marker([country.latlng[0], country.latlng[1]], { icon: markerIcon });
        marker.addTo(map);
      }

      function hideMapOfCountry() {
        overlay.style.display = 'none';
        mapWindow.style.display = 'none';
      }

      function showCountryCitiesTable(countryName) {
        const country = independentCountries.find((country) => country.name.common === countryName);
        if (!country) return;
        const cityTable = document.getElementById('city-table');
        cityTable.innerHTML = '<div class="loader"></div>';
        cityTable.style.display = 'block';
        const apiUrl = `https://secure.geonames.org/searchJSON?country=${getCountryCode(country)}&featureCode=PPLC&featureCode=PPLA&maxRows=1000&username=flaks`;
        loadResource(apiUrl, 'text')
          .then(data => {
            const cachedData = JSON.parse(data);
            if (cachedData.status && cachedData.status.value === 19) {
              throw new Error('Request limit exceeded');
            }
            console.log(cachedData);
            processCityData(cachedData);
          })
          .catch(error => {
            console.error('Error:', error);
            cityTable.innerHTML = '<div class="error-message">Sorry, an error occurred while fetching city data. Please try again later.</div>';
          });

        function processCityData({ geonames }) {
          const filteredCities = geonames.filter((cityData) => cityData.population > 0).sort((a, b) => b.population - a.population);
          const citiesPerPage = countriesPerPage > 15 ? 15 : countriesPerPage;
          const totalPages = Math.ceil(filteredCities.length / citiesPerPage);
          const divContainer = document.createElement('div');
          divContainer.innerHTML = `
            <h2 class="city-title">Cities of ${countryName}</h2>
            <span class="material-symbols-outlined close-icon">close</span>
            <table id="cities-list"></table>
            <div class="cities-pagination">
              <div class="cities-pagination-container"></div>
            </div>`;
          const closeIcon = divContainer.querySelector('.close-icon');
          const citiesTable = divContainer.querySelector('#cities-list');
          cityTable.innerHTML = '';
          cityTable.appendChild(divContainer);
          function renderCitiesTable(page) {
            const startIndex = (page - 1) * citiesPerPage;
            const endIndex = startIndex + citiesPerPage;
            const citiesToShow = filteredCities.slice(startIndex, endIndex);
            citiesTable.innerHTML = `
              <tr>
                <th>City</th>
                <th>Population</th>
                <th>Wiki</th>
              </tr> ${citiesToShow.map((cityData) => `
                <tr onclick="openCountryWiki('${cityData.name}')">
                  <td>${cityData.name}</td>
                  <td>${cityData.population}</td>
                  <td><span class="cities-wiki-icon">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/1/14/OOjs_UI_icon_logo-wikipedia.svg" alt="Wikipedia">
                </span></td>
                </tr>`).join('')}`;
          }
          renderCitiesTable(1);
          if (totalPages > 1) {
            renderCitiesPagination(totalPages);
          }
          overlay.style.display = 'block';
          closeIcon.addEventListener('click', hideCountryCitiesTable);
          overlay.addEventListener('click', hideCountryCitiesTable);

          function renderCitiesPagination(totalPages) {
            paginationContainer.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
              const button = document.createElement('button');
              button.textContent = i;
              button.addEventListener('click', () => {
                renderCitiesTable(i);
                const buttons = paginationContainer.querySelectorAll('button');
                buttons.forEach((btn) => btn.classList.remove('active'));
                button.classList.add('active');
              });
              if (i === 1) {
                button.classList.add('active');
              }
              paginationContainer.appendChild(button);
            }
          }
        }
      }

      function hideCountryCitiesTable() {
        cityTable.style.display = 'none';
        overlay.style.display = 'none';
      }

      function getNeighboringCountries(country) {
        if (country.borders && country.borders.length > 0) {
          const neighboringCountries = country.borders
            .map(border => {
              const neighboringCountry = independentCountries.find(c => c.cca3 === border);
              return neighboringCountry ? `<img class="neighboring-country-icon" src="https://flagcdn.com/24x18/${getCountryCode(neighboringCountry)}.png" alt="${neighboringCountry.name.common} Flag" onclick="showNeighboringCountry('${neighboringCountry.name.common}')"> ${neighboringCountry.name.common}` : '';
            })
            .filter(Boolean);
          return neighboringCountries.join(', ');
        }
        return "Don't Have";
      }


      function getCountryCode(country) {
        return (country.cca2 || country.cca3).toLowerCase();
      }

      function getCurrency(currencies) {
        const currencyKeys = Object.keys(currencies);
        if (currencyKeys.length > 0) {
          const currencyCode = currencyKeys[0];
          const currency = currencies[currencyCode];
          return `${currency.name} (${currencyCode})`;
        }
        return 'N/A';
      }

      function getCurrencyCode(currencies) {
        const currencyKeys = Object.keys(currencies);
        if (currencyKeys.length > 0) {
          const currencyCode = currencyKeys[0];
          return `${currencyCode}`;
        }
        return 'N/A';
      }

      function sortTable() {
        toggleSortOrder();
        filteredCountries.reverse();
        renderCountriesTable(filteredCountries, currentPage);
        updateSortButton();
      }
      function toggleSortOrder() {
        sortOrder = !sortOrder;
        const sortSymbol = document.getElementById('sort-symbol');
        sortSymbol.style.transform = `rotate(${sortOrder ? '90deg' : '270deg'})`;
      }

      function updateSortButton() {
        const sortSymbol = document.getElementById('sort-symbol');
        sortSymbol.style.transform = `rotate(${sortOrder ? '90deg' : '270deg'})`;
        sortButton.dataset.sortOrder = sortOrder ? 'asc' : 'desc';
      }

      function openCountryWiki(countryName) {
        const wikiUrl = `https://en.wikipedia.org/wiki/${countryName}`;
        window.open(wikiUrl, '_blank');
      }

      function showFilterWindow() {
        filterWindow.style.display = 'block';
        overlay.style.display = 'block';
        const closeButton = filterWindow.querySelector('.close-icon');
        closeButton.addEventListener('click', hideFilterWindow);
        overlay.addEventListener('click', hideFilterWindow);
        regionToggleLabels.forEach((toggleLabel, index) => {
          const toggleIcon = toggleLabel.querySelector('.toggle-icon');
          const regionToggle = regionToggles[index];
          toggleLabel.addEventListener('click', function () {
            regionToggle.checked = !regionToggle.checked;
            toggleIcon.src = regionToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
          });
          const initialRegionToggleValue = localStorage.getItem(`regionToggle${index}`);
          const initialToggleState = initialRegionToggleValue ? initialRegionToggleValue === 'true' : false;
          regionToggle.checked = initialToggleState;
          toggleIcon.src = initialToggleState ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
          toggleStates[index] = initialToggleState;
        });
      }

      function hideFilterWindow() {
        overlay.style.display = 'none';
        filterWindow.style.display = 'none';
      }

      function toggleDarkMode() {
        const currentIcon = darkModeToggle.textContent;
        const newIcon = currentIcon === 'dark_mode' ? 'light_mode' : 'dark_mode';
        document.body.classList.toggle('dark-mode', newIcon === 'dark_mode');
        document.body.classList.toggle('light-mode', newIcon === 'light_mode');
        darkModeToggle.textContent = newIcon;
        localStorage.setItem('darkModeIcon', newIcon);
      }

      function showSettingsWindow() {
        if (mapWindow && mapWindow.style.display === 'block') {
          hideMapOfCountry();
        }
        if (cityTable && cityTable.style.display === 'block') {
          hideCountryCitiesTable();
        }
        if (filterWindow && filterWindow.style.display === 'block') {
          hideFilterWindow();
        }
        settingsWindow.style.display = 'block';
        overlay.style.display = 'block';
        const closeButton = settingsWindow.querySelector('.close-icon');
        closeButton.addEventListener('click', hideSettingsWindow);
        overlay.addEventListener('click', hideSettingsWindow);
      }

      function hideSettingsWindow() {
        overlay.style.display = 'none';
        settingsWindow.style.display = 'none';
      }

      function handleError(error, countryCard) {
        console.log('Error:', error);
        if (countryCard) countryCard.innerHTML = 'Failed to fetch country information.';
      }

      document.addEventListener('DOMContentLoaded', function () {
        toggleSortOrder();
        updateSortButton();
        const savedIcon = localStorage.getItem('darkModeIcon');
        if (savedIcon) {
          darkModeToggle.textContent = savedIcon;
        }
        document.body.classList.add(darkModeToggle.textContent === 'dark_mode' ? 'dark-mode' : 'light-mode');
        bigCardToggle = document.getElementById('big-card-toggle');
        const bigCardToggleIcon = document.querySelector('#settings-window .toggle-icon');
        const bigCardToggleLabel = document.querySelector('#settings-window .toggle-label');
        bigCardToggleLabel.addEventListener('click', function () {
          bigCardToggle.checked = !bigCardToggle.checked;
          bigCardToggleIcon.src = bigCardToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
          localStorage.setItem('bigCardToggle', bigCardToggle.checked);
        });
        const initialBigCardValue = localStorage.getItem('bigCardToggle');
        if (initialBigCardValue) {
          bigCardToggle.checked = initialBigCardValue === 'true';
        }
        bigCardToggleIcon.src = bigCardToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
        regionToggleLabels.forEach((toggleLabel, index) => {
          const toggleIcon = toggleLabel.querySelector('.toggle-icon');
          const regionToggle = regionToggles[index];
          toggleLabel.addEventListener('click', function () {
            regionToggle.checked = !regionToggle.checked;
            toggleIcon.src = regionToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
          });
          const initialRegionToggleValue = localStorage.getItem(`regionToggle${index}`);
          const initialToggleState = initialRegionToggleValue ? initialRegionToggleValue === 'true' : false;
          regionToggle.checked = initialToggleState;
          toggleIcon.src = initialToggleState ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
          toggleStates[index] = initialToggleState;
        });
        fetchCountries();
      });
    </script>
  </div>
</body>

</html>