<!DOCTYPE html>
<html>

<head>
  <title>NationHub</title>
  <link rel="icon" type="image/png" href="/images/favicon-32x32.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-spacing: 0;
      border-collapse: separate;
    }

    .dark-mode table {
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.1);
    }

    table th,
    table td {
      text-align: left;
      padding: 7px;
    }

    table tr:first-child {
      background-color: #525252;
      color: white;
    }

    .dark-mode table tr:first-child {
      background-color: #cacaca;
      color: black;
    }

    table tr:not(:first-child) {
      transition: transform 0.3s ease;
    }

    table tr:not(:first-child):hover,
    tr.selected {
      cursor: pointer;
      transform: scale(1.1);
      filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.7));
    }

    .dark-mode table tr:not(:first-child):hover,
    .dark-mode tr.selected {
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
    }

    table tr:first-child th:first-child {
      border-top-left-radius: 6px;
    }

    table tr:first-child th:last-child {
      border-top-right-radius: 6px;
    }

    table tr:last-child td:first-child {
      border-bottom-left-radius: 10px;
    }

    table tr:last-child td:last-child {
      border-bottom-right-radius: 10px;
    }

    table tr:not(:first-child):nth-child(odd) {
      background-color: #f8f8f8;
    }

    .dark-mode tr:not(:first-child):nth-child(odd) {
      background-color: #585858;
    }

    table tr:nth-child(even) {
      background-color: #e6e6e6;
    }

    .dark-mode table tr:nth-child(even) {
      background-color: #474747;
    }

    .table-container {
      margin-left: 5%;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      border: 2px solid #333;
      border-spacing: 0;
      border-collapse: separate;
      width: 25%;
    }

    .dark-mode .table-container {
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.1);
      border: 2px solid #f0f0f0;
    }

    body {
      font-family: 'Roboto Mono', monospace;
      background-color: #d1d1d1;
    }

    body.dark-mode {
      background-color: #242424;
      color: white;
    }

    h1 {
      display: flex;
      align-items: center;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      background-color: #f2f2f2;
      border-radius: 10px;
      border: 2px solid #333;
      position: relative;
      z-index: 999;
      width: fit-content;
      padding-right: 5px;
    }

    .dark-mode h1 {
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.2);
      background-color: #3d3d3d;
      border: 2px solid #f0f0f0;
    }

    .logo {
      color: rgb(28, 155, 11);
      filter: drop-shadow(0 0 1rem rgb(28, 155, 11));
      font-size: 48px;
      cursor: pointer;
      background-color: transparent;
    }

    .header {
      font-size: 36px;
      cursor: pointer;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 998;
      display: none;
      backdrop-filter: blur(2px);
    }

    .dark-mode-icon {
      font-size: 36px;
      margin-right: 64px;
      cursor: pointer;
      position: fixed;
      right: 10px;
    }

    .settings {
      font-size: 48px;
      margin-right: 5px;
      cursor: pointer;
      position: fixed;
      right: 10px;
    }

    .settings-title {
      margin-top: 1px;
      font-size: 36px;
    }

    .toggle-container {
      display: flex;
      align-items: center;
    }

    .toggle-icon {
      width: 36px;
      height: 36px;
      margin-left: 15px;
      cursor: pointer;
      vertical-align: middle;
    }

    #settings-window,
    #map-window,
    #city-table {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
      background-color: #f2f2f2;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      border: 2px solid #333;
      font-size: 18px;
    }

    .dark-mode #settings-window,
    .dark-mode #map-window,
    .dark-mode #city-table {
      background-color: #3d3d3d;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
      border: 2px solid #f0f0f0;
    }

    .country-card {
      position: fixed;
      top: 50%;
      left: 75%;
      transform: translate(-50%, -50%);
      line-height: 1;
      background-color: #f2f2f2;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      border: 2px solid #333;
    }

    .dark-mode .country-card {
      background-color: #3d3d3d;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
      border: 2px solid #f0f0f0;
    }

    .country-card h2 {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }

    .country-card p {
      margin-top: 7px;
      margin-bottom: 7px;
    }

    .map-icon,
    .cities-icon,
    .wiki-icon {
      margin-left: 5px;
      cursor: pointer;
    }

    .wiki-icon {
      position: absolute;
      bottom: 10px;
      right: 10px;
      transform: scale(1.5);
    }

    .cities-wiki-icon {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dark-mode .wiki-icon,
    .dark-mode .cities-wiki-icon {
      filter: invert(100%);
    }

    #map-container {
      width: 45vw;
      height: 45vh;
      border-radius: 10px;
      border: 2px solid #333;
    }

    .dark-mode #map-container {
      border: 2px solid #f0f0f0;
    }

    #map-buttons {
      display: flex;
      margin-bottom: 5px;
    }

    .map-button-icon {
      width: 36px;
      height: 36px;
      vertical-align: middle;
    }

    #openstreetmap-button,
    #googlemaps-button {
      padding: 5px;
      background-color: #f2f2f2;
      border-radius: 10px;
      border: 2px solid #333;
      cursor: pointer;
    }

    #cities-list {
      border-radius: 10px;
      border: 2px solid #333;
      margin-bottom: 30px;
    }

    .dark-mode #cities-list {
      border: 2px solid #f0f0f0;
    }

    .neighboring-country-icon {
      cursor: pointer;
    }

    .pagination {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
    }

    .cities-pagination {
      align-items: center;
    }

    .pagination,
    .cities-pagination {
      display: flex;
      justify-content: center;
    }

    .pagination-container,
    .cities-pagination-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }

    .pagination button,
    .cities-pagination button {
      margin: 0 5px;
      padding: 5px 10px;
      background-color: #f2f2f2;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .pagination button.active,
    .cities-pagination button.active {
      background-color: #525252;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
      color: white;
    }

    .dark-mode .pagination button,
    .dark-mode .cities-pagination button {
      color: white;
      background-color: #525252;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    }

    .dark-mode .pagination button.active,
    .dark-mode .cities-pagination button.active {
      background-color: #f2f2f2;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
      color: black;
    }

    .flag-column {
      width: 5%;
    }

    .country-column {
      width: 90%;
    }

    .country-column::after {
      content: '';
      display: inline-block;
      height: 100%;
      vertical-align: middle;
    }

    .country-column span {
      display: inline-block;
      vertical-align: middle;
    }

    .sort-button {
      border: none;
      color: white;
      background: none;
      padding: 0;
      cursor: pointer;
    }

    .dark-mode .sort-button {
      color: black;
    }

    .sort-button span {
      display: inline-block;
      overflow: hidden;
      background-repeat: no-repeat;
      background-position: center;
    }

    .sort-icon {
      transform: rotate(270deg);
    }

    #expand-icon,
    #expand-icon-less {
      font-size: 24px;
      cursor: pointer;
    }

    .flag-coat {
      display: flex;
      align-items: center;
    }

    .flag-coat img {
      height: 120px;
      border-radius: 10px;
      background-color: #f2f2f2;
      border: 2px solid #333;
    }

    .dark-mode .flag-coat img {
      border: 2px solid #f0f0f0;
    }

    .flag-coat img.flag-image {
      margin-right: 50px;
    }

    .flag-coat img.coat-image {
      width: 120px;
      object-fit: contain;
      object-position: center;
      min-width: 120px;
    }

    .close-icon {
      font-size: 24px;
      position: absolute;
      top: 1px;
      right: 1px;
      cursor: pointer;
    }

    .gdp-growth {
      font-weight: bold;
    }

    .gdp-growth.positive {
      color: green;
    }

    .gdp-growth.negative {
      color: red;
    }

    .loader {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00000000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.7));
    }

    .dark-mode .loader {
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (orientation: portrait) {
      .table-container {
        width: 90%;
      }

      #settings-window,
      #city-table {
        font-size: calc(18px + (100vh - 100vw) / 100);
      }

      .toggle-icon {
        width: calc(36px + (100vh - 100vw) / 50);
        height: calc(36px + (100vh - 100vw) / 50);
      }

      .close-icon,
      #expand-icon {
        font-size: calc(24px + (100vh - 100vw) / 100);
      }

      .country-card h2 {
        font-size: calc(24px + (100vh - 100vw) / 100);
      }

      .country-card p {
        font-size: calc(18px + (100vh - 100vw) / 100);
        margin-bottom: 0;
      }

      .country-card {
        top: auto;
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
      }

      .pagination button,
      .cities-pagination button {
        font-size: calc(16px + (100vh - 100vw) / 100);
        padding: 5px 10px;
      }
    }
  </style>
</head>

<body>

  <h1>
    <span class="material-symbols-outlined logo" onclick="location.reload()">public</span>
    <span class="header" onclick="location.reload()">NationHub</span>
    <span class="material-symbols-outlined settings" onclick="showSettingsWindow()">settings</span>
    <span id="dark-mode-toggle" class="material-symbols-outlined dark-mode-icon"
      onclick="toggleDarkMode()">dark_mode</span>
  </h1>

  <div class="table-container">
    <table id="countries-table">
      <tr>
        <th class="flag-column"></th>
        <th class="country-column">
          <span>Country</span>
          <button class="sort-button" onclick="sortTable()">
            <span id="sort-symbol" class="material-symbols-outlined sort-icon">switch_right</span>
          </button>
        </th>
      </tr>
    </table>

    <div class="overlay"></div>

    <div id="settings-window">
      <h2 class="settings-title">Settings</h2>
      <div class="toggle-container">
        <strong>Open Big Card by Default:</strong>
        <label class="toggle-label" for="big-card-toggle">
          <input type="checkbox" id="big-card-toggle" hidden>
          <img class="toggle-icon" src="/images/toggle_off.svg" alt="Toggle Icon">
        </label>
      </div>
      <span class="material-symbols-outlined close-icon">close</span>
    </div>

    <div id="map-window">
      <h2 class="map-title">Map of <span id="country-name"></span></h2>
      <div id="map-buttons">
        <button id="googlemaps-button">
          <img class="map-button-icon" src="images/maps-icon.svg" alt="GoogleMap Logo">
        </button>
        <button id="openstreetmap-button">
          <img class="map-button-icon" src="images/osm-icon.svg" alt="OpenStreetMap Logo">
        </button>
      </div>
      <span class="material-symbols-outlined close-icon">close</span>
      <div id="map-container"></div>
    </div>

    <div class="table" id="city-table"></div>

    <div class="pagination">
      <div class="pagination-container"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
      const h1Element = document.querySelector('h1');
      const paginationElement = document.querySelector('.pagination');
      const mapWindow = document.getElementById('map-window');
      const cityTable = document.getElementById('city-table');
      const paginationContainer = document.querySelector('.pagination-container');
      const countriesTable = document.getElementById('countries-table');
      const overlay = document.querySelector('.overlay');
      const countryNameElement = document.getElementById('country-name');
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const settingsWindow = document.getElementById('settings-window');
      const sortButton = document.querySelector('.sort-button');

      let sortOrder = true;
      let currentPage = 1;
      let totalPages = 1;
      let independentCountries = [];
      let countriesPerPage = calculateCountriesPerPage();
      function calculateCountriesPerPage() {
        const h1Rect = h1Element.getBoundingClientRect();
        const paginationRect = paginationElement.getBoundingClientRect();
        const distanceToButtons = paginationRect.top - (h1Rect.top + h1Rect.height);
        const heightDifference = window.innerHeight - window.innerWidth;
        if (window.matchMedia("(orientation: portrait)").matches) {
          const screenHeight = window.innerHeight;
          const distanceToCenter = screenHeight / 2 - (h1Rect.top + h1Rect.height);
          const fontSize = 16 + heightDifference / 100;
          document.body.style.fontSize = fontSize + 'px';
          return Math.floor(distanceToCenter / 58);
        } else {
          document.body.style.fontSize = '16px';
          return Math.floor(distanceToButtons / 42.65);
        }
      }

      window.addEventListener('resize', function () {
        countriesPerPage = calculateCountriesPerPage();
        renderPagination(Math.ceil(independentCountries.length / countriesPerPage));
        if (mapWindow && mapWindow.style.display === 'block') {
          hideMapOfCountry();
        }
        if (cityTable && cityTable.style.display === 'block') {
          hideCountryCitiesTable();
        }
        hideCountryInfo();
        setCurrentPage(1);
      });

      function fetchCountries() {
        fetch('https://restcountries.com/v3.1/all')
          .then(response => response.json())
          .then(data => {
            independentCountries = data.filter(country => country.independent);
            independentCountries.sort((a, b) => a.name.common.localeCompare(b.name.common));
            totalPages = Math.ceil(independentCountries.length / countriesPerPage);
            currentPage = 1;
            renderPagination(totalPages);
            if (currentPage === 1) {
              renderCountriesTable(independentCountries, currentPage);
            }
          })
          .catch(error => console.log('Error:', error));
      }

      function renderPagination(totalPages) {
        paginationContainer.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
          const button = document.createElement('button');
          button.textContent = i;
          button.addEventListener('click', () => setCurrentPage(i));
          if (i === currentPage) {
            button.classList.add('active');
          }
          paginationContainer.appendChild(button);
        }
      }

      async function renderCountriesTable(countries, currentPage) {
        const startIndex = (currentPage - 1) * countriesPerPage;
        countriesTable.innerHTML = `
          <tr>
            <th class="flag-column"></th>
            <th class="country-column">
              <span>Country</span>
              <button class="sort-button" onclick="sortTable()">
              <span id="sort-symbol" class="material-symbols-outlined sort-icon">switch_right</span>
              </button>
            </th>
          </tr>`;
        const imagePromises = [];
        for (let i = startIndex; i < startIndex + countriesPerPage; i++) {
          const country = countries[i];
          if (!country) break;
          const countryName = country.name.common;
          const row = document.createElement('tr');
          const imagePromise = loadResource(`https://flagcdn.com/24x18/${getCountryCode(country)}.png`, 'image');
          imagePromises.push(imagePromise);
          const imageCell = document.createElement('td');
          row.appendChild(imageCell);
          const countryNameCell = document.createElement('td');
          countryNameCell.textContent = countryName;
          row.appendChild(countryNameCell);
          row.addEventListener('click', () => bigCardToggle.checked ? showExpandedCountryInfo(row, country) : showCountryInfo(row, country));
          countriesTable.appendChild(row);
        }
        const images = await Promise.all(imagePromises);
        const flagCells = Array.from(countriesTable.querySelectorAll('td:first-child'));
        flagCells.forEach((cell, index) => {
          const img = document.createElement('img');
          img.src = images[index].src;
          img.width = 24;
          img.height = 18;
          img.alt = countries[startIndex + index].name.common + ' Flag';
          cell.appendChild(img);
        });
      }

      function setCurrentPage(page) {
        currentPage = page;
        renderPagination(totalPages);
        renderCountriesTable(independentCountries, currentPage);
      }

      let openCountryRow = null;
      let openExpandedCountryRow = null;

      function showExpandedCountryInfo(row, country) {
        if (!(openExpandedCountryRow && openExpandedCountryRow.rowElement === row)) {
          hideCountryInfo();
          const countryCard = document.createElement('div');
          countryCard.classList.add('country-card');
          countryCard.innerHTML = '<div class="loader"></div>';
          const apiUrl = `https://api.api-ninjas.com/v1/country?name=${getCountryCode(country)}`;
          loadResource(apiUrl, 'text', { headers: { 'X-Api-Key': 'W+OQ/iBAPzIQYLIRvdQgVQ==ixnCBWtlJHxmXrMv' } })
            .then(data => {
              const cachedData = JSON.parse(data);
              renderCountryInfo(cachedData);
            })
            .catch(error => {
              handleError(error, countryCard);
            });

          function renderCountryInfo(data) {
            const countryData = data[0];
            const gdp = countryData.gdp || 'N/A';
            const gdpGrowth = countryData.gdp_growth || 'N/A';
            const gdpPerCapita = countryData.gdp_per_capita || 'N/A';
            const territory = countryData.surface_area || 'N/A';
            const currencyCode = getCurrencyCode(country.currencies);
            const exchangeUrl = `https://api.api-ninjas.com/v1/convertcurrency?have=${currencyCode}&want=USD&amount=1`;
            loadResource(exchangeUrl, 'text')
              .then(data => {
                const cachedData = JSON.parse(data);
                displayCountryInfo(cachedData);
              })
              .catch(error => {
                handleError(error, countryCard);
              });

            async function displayCountryInfo(data) {
              const exchangeRate = data.new_amount;
              const currencyDisplay = `${currencyCode} (${exchangeRate.toFixed(2)} USD)`;
              const flagImage = await loadResource(`https://flagcdn.com/h120/${getCountryCode(country)}.png`, 'image');
              countryCard.innerHTML = `
                <span class="flag-coat">
                  <img class="flag-image" src="${flagImage.src}" alt="${country.name.common} Flag">
                  <img class="coat-image" src="https://mainfacts.com/media/images/coats_of_arms/${getCountryCode(country)}.svg" alt="${country.name.common} Coat">
                </span>
                <span class="material-symbols-outlined close-icon">close</span>
                <h2>
                  ${country.name.common}
                  <span class="material-symbols-outlined map-icon" onclick="showMapOfCountry('${country.name.common}')">location_on</span>
                  <span class="material-symbols-outlined cities-icon" onclick="showCountryCitiesTable('${country.name.common}')">apartment</span>
                </h2>
                <p><strong>Capital:</strong> ${country.capital}</p>
                <p><strong>Language:</strong> ${country.languages[Object.keys(country.languages)[0]]}</p>
                <p><strong>Currency:</strong> ${currencyDisplay}</p>
                <p><strong>GDP:</strong> $${(gdp / 1000).toFixed(2)}b <i class="fas fa-dollar-sign"></i></p>
                <p><strong>GDP Per Capita:</strong> $${gdpPerCapita} <i class="fas fa-dollar-sign"></i></p>
                <p><strong>GDP Growth:</strong> <span class="gdp-growth ${gdpGrowth > 0 ? 'positive' : 'negative'}">${gdpGrowth}% ${gdpGrowth > 0 ? '&#8593;' : '&#8595;'}</span></p>
                <p><strong>Population:</strong> ${country.population.toLocaleString()}</p>
                <p><strong>Territory:</strong> ${territory} km<sup>2</sup></p>
                <p><strong>Region:</strong> ${country.region}/${country.subregion}</p>
                <p><strong>Neighboring Countries:</strong> ${getNeighboringCountries(country)}</p>
                <span class="wiki-icon" onclick="openCountryWiki('${country.name.common}')">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/1/14/OOjs_UI_icon_logo-wikipedia.svg" alt="Wikipedia">
                </span>
                <span id="expand-icon-less" class="material-symbols-outlined">expand_less</span>`;
              const closeIcon = countryCard.querySelector('.close-icon');
              closeIcon?.addEventListener('click', () => hideCountryInfo());
              const expandIcon = document.getElementById('expand-icon-less');
              expandIcon?.addEventListener('click', () => showCountryInfo(row, country));
              const maxHeight = window.innerHeight * 0.7;
              if (countryCard.offsetHeight > maxHeight) {
                countryCard.style.fontSize = '12px';
              } else {
                countryCard.style.fontSize = '18px';
              }
            }
          }
          row.classList.add('selected');
          document.body.appendChild(countryCard);
          openExpandedCountryRow = {
            rowElement: row,
            countryCard: countryCard
          };
        }
      }

      function showCountryInfo(row, country) {
        if (!(openCountryRow && openCountryRow.rowElement === row)) {
          hideCountryInfo();
          const countryCard = document.createElement('div');
          countryCard.classList.add('country-card');
          countryCard.innerHTML = `
            <img src="https://flagcdn.com/h120/${getCountryCode(country)}.png" height="120" width="190" alt="${country.name.common} Flag">
            <span class="material-symbols-outlined close-icon">close</span>
            <h2>${country.name.common}</h2>
            <p><strong>Capital:</strong> ${country.capital}</p>
            <p><strong>Language:</strong> ${country.languages[Object.keys(country.languages)[0]]}</p>
            <p><strong>Population:</strong> ${country.population.toLocaleString()}</p>
            <span id="expand-icon" class="material-symbols-outlined">expand_more</span>`;
          row.classList.add('selected');
          document.body.appendChild(countryCard);
          openCountryRow = {
            rowElement: row,
            countryCard: countryCard
          };
          const closeIcon = countryCard.querySelector('.close-icon');
          closeIcon?.addEventListener('click', () => hideCountryInfo());
          const expandIcon = document.getElementById('expand-icon');
          expandIcon?.addEventListener('click', () => showExpandedCountryInfo(row, country));
        }
      }

      function showNeighboringCountry(countryName) {
        if (!countryName) return;
        const country = independentCountries.find(c => c.name.common === countryName);
        let row = getRowOfCountry(country);
        if (!row) {
          const countryIndex = independentCountries.findIndex(c => c.name.common === country.name.common);
          const page = Math.ceil((countryIndex + 1) / countriesPerPage);
          setCurrentPage(page);
          row = getRowOfCountry(country);
        }
        function getRowOfCountry(country) {
          const rows = countriesTable.getElementsByTagName('tr');
          for (let i = 1; i < rows.length; i++) {
            const currentRow = rows[i];
            const countryName = currentRow.getElementsByTagName('td')[1].textContent.trim();
            if (countryName === country.name.common) {
              return currentRow;
            }
          }
          return null;
        }
        showExpandedCountryInfo(row, country);
      }

      function hideCountryInfo() {
        if (openCountryRow) {
          if (openCountryRow.rowElement) {
            openCountryRow.rowElement.classList.remove('selected');
          }
          if (openCountryRow.countryCard) {
            document.body.removeChild(openCountryRow.countryCard);
          }
          openCountryRow = null;
        }
        if (openExpandedCountryRow) {
          if (openExpandedCountryRow.rowElement) {
            openExpandedCountryRow.rowElement.classList.remove('selected');
          }
          if (openExpandedCountryRow.countryCard) {
            document.body.removeChild(openExpandedCountryRow.countryCard);
          }
          openExpandedCountryRow = null;
        }
      }

      let map = null;

      function showMapOfCountry(countryName) {
        const country = independentCountries.find(country => country.name.common === countryName);
        if (!country) return;
        countryNameElement.textContent = countryName;
        overlay.style.display = 'block';
        mapWindow.style.display = 'block';
        const closeButton = mapWindow.querySelector('.close-icon');
        closeButton.addEventListener('click', hideMapOfCountry);
        overlay.addEventListener('click', hideMapOfCountry);
        mapWindow.appendChild(document.getElementById('map-container'));
        if (!map) {
          map = L.map('map-container');
          const openstreetmapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          });
          const googlemapsStreetsLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
          });
          googlemapsStreetsLayer.addTo(map);
          const openstreetmapButton = document.getElementById('openstreetmap-button');
          const googlemapsButton = document.getElementById('googlemaps-button');
          openstreetmapButton.addEventListener('click', () => {
            if (map.hasLayer(googlemapsStreetsLayer)) {
              map.removeLayer(googlemapsStreetsLayer);
              openstreetmapLayer.addTo(map);
            }
          });
          googlemapsButton.addEventListener('click', () => {
            if (!map.hasLayer(googlemapsStreetsLayer)) {
              map.removeLayer(openstreetmapLayer);
              googlemapsStreetsLayer.addTo(map);
            }
          });
        }
        map.setView([country.latlng[0], country.latlng[1]], 5);
        const markerIcon = L.icon({
          iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/d/d1/Google_Maps_pin.svg',
          iconSize: [25, 41],
          iconAnchor: [12, 41]
        });
        const marker = L.marker([country.latlng[0], country.latlng[1]], { icon: markerIcon });
        marker.addTo(map);
      }

      function hideMapOfCountry() {
        overlay.style.display = 'none';
        mapWindow.style.display = 'none';
      }

      function showCountryCitiesTable(countryName) {
        const country = independentCountries.find((country) => country.name.common === countryName);
        if (!country) return;
        const cityTable = document.getElementById('city-table');
        cityTable.innerHTML = '<div class="loader"></div>';
        cityTable.style.display = 'block';
        const apiUrl = `https://secure.geonames.org/searchJSON?country=${getCountryCode(country)}&featureCode=PPLC&featureCode=PPLA&maxRows=1000&username=flaks`;
        loadResource(apiUrl, 'text')
          .then(data => {
            const cachedData = JSON.parse(data);
            processCityData(cachedData);
          })
          .catch(error => {
            console.log('Error:', error);
          });

        function processCityData({ cities, cityDataArray }) {
          const filteredCities = cityDataArray.filter((cityData) => cityData.population > 0).sort((a, b) => b.population - a.population);
          const citiesPerPage = countriesPerPage > 15 ? 15 : countriesPerPage;
          const totalPages = Math.ceil(filteredCities.length / citiesPerPage);
          const divContainer = document.createElement('div');
          divContainer.innerHTML = `
            <h2 class="city-title">Cities of ${countryName}</h2>
            <span class="material-symbols-outlined close-icon">close</span>
            <table id="cities-list"></table>
            <div class="cities-pagination">
              <div class="cities-pagination-container"></div>
            </div>`;
          const closeIcon = divContainer.querySelector('.close-icon');
          const citiesTable = divContainer.querySelector('#cities-list');
          cityTable.innerHTML = '';
          cityTable.appendChild(divContainer);
          function renderCitiesTable(page) {
            const startIndex = (page - 1) * citiesPerPage;
            const endIndex = startIndex + citiesPerPage;
            const citiesToShow = filteredCities.slice(startIndex, endIndex);
            citiesTable.innerHTML = `
              <tr>
                <th>City</th>
                <th>Population</th>
                <th>Wiki</th>
              </tr> ${citiesToShow.map((cityData) => `
                <tr onclick="openCountryWiki('${cityData.name}')">
                  <td>${cityData.name}</td>
                  <td>${cityData.population}</td>
                  <td><span class="cities-wiki-icon">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/1/14/OOjs_UI_icon_logo-wikipedia.svg" alt="Wikipedia">
                </span></td>
                </tr>`).join('')}`;
          }
          renderCitiesTable(1);
          if (totalPages > 1) {
            renderCitiesPagination(totalPages);
          }
          overlay.style.display = 'block';
          closeIcon.addEventListener('click', hideCountryCitiesTable);
          overlay.addEventListener('click', hideCountryCitiesTable);

          function renderCitiesPagination(totalPages) {
            paginationContainer.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
              const button = document.createElement('button');
              button.textContent = i;
              button.addEventListener('click', () => {
                renderCitiesTable(i);
                const buttons = paginationContainer.querySelectorAll('button');
                buttons.forEach((btn) => btn.classList.remove('active'));
                button.classList.add('active');
              });
              if (i === 1) {
                button.classList.add('active');
              }
              paginationContainer.appendChild(button);
            }
          }
        }
      }

      function hideCountryCitiesTable() {
        cityTable.style.display = 'none';
        overlay.style.display = 'none';
      }

      function getNeighboringCountries(country) {
        if (country.borders && country.borders.length > 0) {
          const neighboringCountries = country.borders
            .map(border => {
              const neighboringCountry = independentCountries.find(c => c.cca3 === border);
              return neighboringCountry ? `<img class="neighboring-country-icon" src="https://flagcdn.com/24x18/${getCountryCode(neighboringCountry)}.png" alt="${neighboringCountry.name.common} Flag" onclick="showNeighboringCountry('${neighboringCountry.name.common}')"> ${neighboringCountry.name.common}` : '';
            })
            .filter(Boolean);
          return neighboringCountries.join(', ');
        }
        return "Don't Have";
      }


      function getCountryCode(country) {
        return (country.cca2 || country.cca3).toLowerCase();
      }

      function getCurrency(currencies) {
        const currencyKeys = Object.keys(currencies);
        if (currencyKeys.length > 0) {
          const currencyCode = currencyKeys[0];
          const currency = currencies[currencyCode];
          return `${currency.name} (${currencyCode})`;
        }
        return 'N/A';
      }

      function getCurrencyCode(currencies) {
        const currencyKeys = Object.keys(currencies);
        if (currencyKeys.length > 0) {
          const currencyCode = currencyKeys[0];
          return `${currencyCode}`;
        }
        return 'N/A';
      }

      function sortTable() {
        toggleSortOrder();
        independentCountries.reverse();
        renderCountriesTable(independentCountries, currentPage);
        updateSortButton();
      }

      function toggleSortOrder() {
        sortOrder = !sortOrder;
        const sortSymbol = document.getElementById('sort-symbol');
        sortSymbol.style.transform = `rotate(${sortOrder ? '90deg' : '270deg'})`;
      }

      function updateSortButton() {
        const sortSymbol = document.getElementById('sort-symbol');
        sortSymbol.style.transform = `rotate(${sortOrder ? '90deg' : '270deg'})`;
        sortButton.dataset.sortOrder = sortOrder ? 'asc' : 'desc';
      }

      function openCountryWiki(countryName) {
        const wikiUrl = `https://en.wikipedia.org/wiki/${countryName}`;
        window.open(wikiUrl, '_blank');
      }

      function toggleDarkMode() {
        const currentIcon = darkModeToggle.textContent;
        if (currentIcon === 'dark_mode') {
          darkModeToggle.textContent = 'light_mode';
          document.body.classList.remove('dark-mode');
          document.body.classList.add('light-mode');
        } else {
          darkModeToggle.textContent = 'dark_mode';
          document.body.classList.remove('light-mode');
          document.body.classList.add('dark-mode');
        }
        localStorage.setItem('darkModeIcon', darkModeToggle.textContent);
      }

      function showSettingsWindow() {
        if (mapWindow && mapWindow.style.display === 'block') {
          hideMapOfCountry();
        }
        if (cityTable && cityTable.style.display === 'block') {
          hideCountryCitiesTable();
        }
        settingsWindow.style.display = 'block';
        overlay.style.display = 'block';
        const closeButton = settingsWindow.querySelector('.close-icon');
        closeButton.addEventListener('click', hideSettingsWindow);
        overlay.addEventListener('click', hideSettingsWindow);
        function hideSettingsWindow() {
          overlay.style.display = 'none';
          settingsWindow.style.display = 'none';
        }
      }

      function loadResource(url, resourceType, options = {}) {
        return new Promise((resolve, reject) => {
          const cachedResource = localStorage.getItem(url);
          if (cachedResource) {
            if (resourceType === 'image') {
              const image = new Image();
              image.onload = () => resolve(image);
              image.onerror = reject;
              image.src = cachedResource;
            } else {
              resolve(cachedResource);
            }
          } else {
            fetch(url, {
              headers: options.headers || {},
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to fetch resource');
                }
                if (resourceType === 'image') {
                  response.blob().then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                      const imageDataUrl = reader.result;
                      const image = new Image();
                      image.onload = () => {
                        resolve(image);
                        try {
                          localStorage.setItem(url, imageDataUrl);
                        } catch (error) {
                          console.error('Failed to store image in local storage:', error);
                        }
                      };
                      image.onerror = reject;
                      image.src = imageDataUrl;
                    };
                    reader.readAsDataURL(blob);
                  });
                } else {
                  response.text().then(data => {
                    try {
                      localStorage.setItem(url, data);
                    } catch (error) {
                      console.error('Failed to store resource in local storage:', error);
                    }
                    resolve(data);
                  });
                }
              })
              .catch(reject);
          }
        });
      }

      function handleError(error, countryCard) {
        console.log('Error:', error);
        if (countryCard) countryCard.innerHTML = 'Failed to fetch country information.';
      }

      let bigCardToggle;

      document.addEventListener('DOMContentLoaded', function () {
        toggleSortOrder();
        updateSortButton();
        const savedIcon = localStorage.getItem('darkModeIcon');
        if (savedIcon) {
          darkModeToggle.textContent = savedIcon;
        }
        if (darkModeToggle.textContent === 'dark_mode') {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.add('light-mode');
        }
        bigCardToggle = document.getElementById('big-card-toggle');
        const toggleIcon = document.querySelector('.toggle-icon');
        const toggleLabel = document.querySelector('.toggle-label');
        toggleLabel.addEventListener('click', function () {
          bigCardToggle.checked = !bigCardToggle.checked;
          toggleIcon.src = bigCardToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
          localStorage.setItem('bigCardToggle', bigCardToggle.checked);
        });
        const initialBigCardValue = localStorage.getItem('bigCardToggle');
        if (initialBigCardValue) {
          bigCardToggle.checked = initialBigCardValue === 'true';
        }
        toggleIcon.src = bigCardToggle.checked ? '/images/toggle_on.svg' : '/images/toggle_off.svg';
        fetchCountries();
      });
    </script>
  </div>
</body>

</html>